{% comment %}
  TradeUp Store Credit Badge Block
  Displays the customer's current store credit balance

  Settings:
  - style: Badge style (pill, card, text)
  - show_when_zero: Show badge when balance is $0
  - show_tier: Show membership tier alongside balance
{% endcomment %}

{% schema %}
{
  "name": "TradeUp Credit Badge",
  "target": "section",
  "settings": [
    {
      "type": "select",
      "id": "style",
      "label": "Badge Style",
      "options": [
        { "value": "pill", "label": "Pill Badge" },
        { "value": "card", "label": "Card" },
        { "value": "text", "label": "Text Only" }
      ],
      "default": "pill"
    },
    {
      "type": "checkbox",
      "id": "show_when_zero",
      "label": "Show when balance is $0",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_tier",
      "label": "Show Membership Tier",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_login_prompt",
      "label": "Show login prompt for guests",
      "default": true
    },
    {
      "type": "text",
      "id": "login_text",
      "label": "Login Prompt Text",
      "default": "Sign in to view rewards"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#4F46E5"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#1F2937"
    }
  ]
}
{% endschema %}

<style>
  .tradeup-badge {
    font-family: inherit;
  }

  .tradeup-badge--pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: {{ block.settings.primary_color }};
    color: white;
    padding: 8px 16px;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .tradeup-badge--card {
    background: white;
    border: 1px solid #E5E7EB;
    border-radius: 12px;
    padding: 16px;
    display: inline-flex;
    flex-direction: column;
    gap: 4px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .tradeup-badge--text {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: {{ block.settings.text_color }};
  }

  .tradeup-badge__icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .tradeup-badge--pill .tradeup-badge__icon {
    fill: white;
  }

  .tradeup-badge--card .tradeup-badge__icon,
  .tradeup-badge--text .tradeup-badge__icon {
    fill: {{ block.settings.primary_color }};
  }

  .tradeup-badge__label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.7;
  }

  .tradeup-badge__value {
    font-size: 1.25rem;
    font-weight: 700;
    color: {{ block.settings.text_color }};
  }

  .tradeup-badge--pill .tradeup-badge__value {
    color: white;
    font-size: 0.875rem;
  }

  .tradeup-badge__tier {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    color: {{ block.settings.primary_color }};
    font-weight: 500;
  }

  .tradeup-badge__tier-dot {
    width: 6px;
    height: 6px;
    background: {{ block.settings.primary_color }};
    border-radius: 50%;
  }

  .tradeup-badge__login {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: {{ block.settings.text_color }};
    text-decoration: none;
    font-size: 0.875rem;
    opacity: 0.7;
    transition: opacity 0.15s;
  }

  .tradeup-badge__login:hover {
    opacity: 1;
    color: {{ block.settings.primary_color }};
  }

  .tradeup-badge__loading {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .tradeup-badge__spinner {
    width: 16px;
    height: 16px;
    border: 2px solid {{ block.settings.primary_color }};
    border-top-color: transparent;
    border-radius: 50%;
    animation: tradeup-spin 0.8s linear infinite;
  }

  @keyframes tradeup-spin {
    to { transform: rotate(360deg); }
  }

  .tradeup-badge[hidden] {
    display: none !important;
  }
</style>

{% if customer %}
  <div class="tradeup-badge tradeup-badge--{{ block.settings.style }}"
       data-tradeup-credit-badge
       data-customer-id="{{ customer.id }}"
       data-show-zero="{{ block.settings.show_when_zero }}"
       data-show-tier="{{ block.settings.show_tier }}"
       hidden>

    {% if block.settings.style == 'card' %}
      <span class="tradeup-badge__label">Store Credit</span>
      <span class="tradeup-badge__value" data-tradeup-balance>
        <span class="tradeup-badge__loading">
          <span class="tradeup-badge__spinner"></span>
        </span>
      </span>
      {% if block.settings.show_tier %}
        <span class="tradeup-badge__tier" data-tradeup-tier hidden>
          <span class="tradeup-badge__tier-dot"></span>
          <span data-tradeup-tier-name></span>
        </span>
      {% endif %}
    {% else %}
      <svg class="tradeup-badge__icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
      </svg>
      <span class="tradeup-badge__value" data-tradeup-balance>--</span>
      {% if block.settings.show_tier and block.settings.style == 'text' %}
        <span class="tradeup-badge__tier" data-tradeup-tier hidden>
          <span class="tradeup-badge__tier-dot"></span>
          <span data-tradeup-tier-name></span>
        </span>
      {% endif %}
    {% endif %}
  </div>
{% else %}
  {% if block.settings.show_login_prompt %}
    <a href="{{ routes.account_login_url }}" class="tradeup-badge__login">
      <svg class="tradeup-badge__icon" viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
      </svg>
      {{ block.settings.login_text }}
    </a>
  {% endif %}
{% endif %}

<script>
  (function() {
    const badge = document.querySelector('[data-tradeup-credit-badge]');
    if (!badge) return;

    const customerId = badge.dataset.customerId;
    const showZero = badge.dataset.showZero === 'true';
    const showTier = badge.dataset.showTier === 'true';
    const balanceEl = badge.querySelector('[data-tradeup-balance]');
    const tierEl = badge.querySelector('[data-tradeup-tier]');
    const tierNameEl = badge.querySelector('[data-tradeup-tier-name]');

    // Fetch member data from TradeUp API
    async function fetchMemberData() {
      try {
        // The API endpoint should be configured in the app
        const apiBase = window.TRADEUP_API_URL || '/apps/tradeup/api';
        const response = await fetch(`${apiBase}/customer-account/extension/data`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customer_id: customerId })
        });

        if (!response.ok) throw new Error('Failed to fetch');

        const data = await response.json();

        if (!data.is_member) {
          if (!showZero) {
            badge.hidden = true;
          } else {
            balanceEl.textContent = '$0.00';
            badge.hidden = false;
          }
          return;
        }

        const balance = data.stats?.store_credit_balance || 0;

        if (balance === 0 && !showZero) {
          badge.hidden = true;
          return;
        }

        balanceEl.textContent = '$' + balance.toFixed(2);
        badge.hidden = false;

        if (showTier && tierEl && data.member?.tier) {
          tierNameEl.textContent = data.member.tier.name;
          tierEl.hidden = false;
        }

      } catch (error) {
        console.error('TradeUp: Error fetching member data', error);
        badge.hidden = true;
      }
    }

    fetchMemberData();
  })();
</script>
